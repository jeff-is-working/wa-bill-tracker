name: Fetch Bills and Deploy

on:
  schedule:
    # Run at 6 AM and 6 PM Pacific Time (UTC-8/UTC-7)
    - cron: '0 14,2 * * *'
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  test:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests
      
      - name: Run unit tests
        run: |
          python -m pytest tests/ -v --tb=short || python -m unittest discover tests/ -v

  fetch-bills:
    name: Fetch Legislative Bills
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests
      
      - name: Create directories
        run: |
          mkdir -p data
          mkdir -p debug
      
      - name: Fetch bills from WA Legislature API
        run: |
          python scripts/fetch_all_bills.py
        env:
          PYTHONUNBUFFERED: "1"
      
      - name: Validate JSON output
        run: |
          echo "Validating bills.json..."
          python -c "
          import json
          import sys
          
          with open('data/bills.json', 'r') as f:
              data = json.load(f)
          
          bills = data.get('bills', [])
          print(f'Total bills: {len(bills)}')
          
          if len(bills) == 0:
              print('ERROR: No bills found!')
              sys.exit(1)
          
          # Check for valid data
          bills_with_titles = sum(1 for b in bills if b.get('title') and b['title'] != 'No title available')
          bills_with_sponsors = sum(1 for b in bills if b.get('sponsor') and b['sponsor'] not in ['Unknown', 'House Member', 'Senator'])
          
          print(f'Bills with titles: {bills_with_titles}')
          print(f'Bills with sponsors: {bills_with_sponsors}')
          
          # Warn if data quality is low
          if bills_with_titles < len(bills) * 0.5:
              print('WARNING: Less than 50% of bills have titles')
          
          if bills_with_sponsors < len(bills) * 0.5:
              print('WARNING: Less than 50% of bills have sponsors')
          
          # Sample bill
          print('Sample bill:')
          print(json.dumps(bills[0], indent=2))
          "
      
      - name: Upload debug artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: debug-files
          path: debug/
          retention-days: 7
      
      - name: Commit and push changes
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add data/
          git diff --staged --quiet || git commit -m "Update bill data - $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          git push

  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: fetch-bills
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
      
      - name: Pull latest changes
        run: git pull origin main
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  integration-test:
    name: Integration Test
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
      - name: Wait for deployment
        run: sleep 30
      
      - name: Test live site
        run: |
          echo "Testing live site..."
          
          # Test main page loads
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://jeff-is-working.github.io/wa-bill-tracker/")
          if [ "$HTTP_CODE" != "200" ]; then
            echo "ERROR: Main page returned HTTP $HTTP_CODE"
            exit 1
          fi
          echo "Main page: OK (HTTP $HTTP_CODE)"
          
          # Test bills.json is accessible
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://raw.githubusercontent.com/jeff-is-working/wa-bill-tracker/main/data/bills.json")
          if [ "$HTTP_CODE" != "200" ]; then
            echo "ERROR: bills.json returned HTTP $HTTP_CODE"
            exit 1
          fi
          echo "bills.json: OK (HTTP $HTTP_CODE)"
          
          # Verify bills.json has data
          BILL_COUNT=$(curl -s "https://raw.githubusercontent.com/jeff-is-working/wa-bill-tracker/main/data/bills.json" | python3 -c "import sys, json; print(len(json.load(sys.stdin).get('bills', [])))")
          echo "Bill count: $BILL_COUNT"
          
          if [ "$BILL_COUNT" -lt 1 ]; then
            echo "ERROR: No bills in bills.json"
            exit 1
          fi
          
          echo "Integration tests passed!"
